---
title: '[BRIGHTEN Study](http://brightenstudy.com/study-description.html) Data Overview'
author: "Abhishek Pratap @ UW / Sage Bionetworks"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    always_allow_html: yes
    fig_height: 10
    fig_width: 15
  pdf_document: default
---

--------

```{r setup, include=FALSE}
library(data.table)
library(gdata)
library(synapseClient)
library(ggplot2)
library("tidyverse")
library("knitr")
library(xts)
library("printr")
library("sjPlot")
library("ggpubr")
library("rbundle")
library("pheatmap")
synapseLogin()

knitr::opts_chunk$set(echo = F,  message=FALSE, warning=FALSE)
knitr::opts_chunk$set(comment = NA, results = "asis", comment = NA, tidy = F)
```


```{r readData}
phq2 <- fread(synGet("syn10236539")@filePath, data.table = F) %>% filter(week_in_study <= 12)
phq9 <- fread(synGet("syn10236540")@filePath, data.table = F) %>% filter(week_in_study <= 13)
passivefeatures <- fread(synGet("syn10236538")@filePath, data.table = F) %>% filter(week_in_study <= 12)
mdata <- fread(synGet("syn10236547")@filePath, data.table = F)
```

##### Data Types
* Longitudinal
    + passive data collected through ginger.io app [data](https://www.synapse.org/#!Synapse:syn5908849)
    + public health questionnaire [(PHQ9)](http://www.cqaimh.org/pdf/tool_phq9.pdf) [data](https://www.synapse.org/#!Synapse:syn5908857)
    + public health questionnaire [(PHQ2)](http://www.cqaimh.org/pdf/tool_phq2.pdf) [data](https://www.synapse.org/#!Synapse:syn5908863)

    
```{r fig.align='center'}
passive_vars <- data.frame( phoneUsage = c("SMS length", "SMS count",   "Call count","Call duration", "Unreturned calls"),
Other = c("Mobility", "Mobility radius", "Interaction diversity","Missed interactions","Aggregate communication"))
kable(passive_vars, row.names=F, align='l')
```


-------------------

##### Data Summary

* users - `r length(unique(phq2$user_id, phq9$user_id, passivefeatures$user_id))`
* data points in passive data - `r nrow(passivefeatures)`
* number of phq9 surveys - `r nrow(phq9)`
* number of phq2 surveys - `r nrow(phq2)`



#### Study Participation
_number of weeks each participant spent in the study_

```{r fig.height=3, fig.width=5, fig.align='center'}
total_users <- passivefeatures %>% .$user_id %>% unique()

study_participation <- passivefeatures %>% mutate(week_in_study = as.factor(week_in_study)) %>% group_by(week_in_study) %>% summarise(numUsers=length(unique(user_id)),
            percentUsers = (numUsers / length(total_users))*100)       
ggplot(data=study_participation, aes(x=week_in_study, y=percentUsers)) + geom_bar(stat="identity", width=.5, fill="#6E80AE") + theme_bw() + scale_x_discrete(breaks=1:12) + ylab('participant retention rate') + theme(text = element_text(size=8)) + xlab("week in study") + geom_hline(yintercept = 50, color="#A30000", linetype="dashed")
ggsave("plots/compliance_plot1.png", width=3, height=2, units="in", dpi=250)
```



#### Depression Measures over the period of study

```{r}
tmp_phq9 <- phq9 %>% mutate(week_in_study = as.numeric(week_in_study))  %>%
  mutate(week_in_study = factor(as.character(week_in_study), levels= c(1:13)))
xlabs <- paste(levels(tmp_phq9$week_in_study),"\n(N=",table(tmp_phq9$week_in_study),")",sep="")
phq9_boxplot <- ggplot(data=tmp_phq9, aes(y=sum_phq9, x=week_in_study)) + geom_boxplot(alpha=.7) + theme_bw() + ylab('Sum PHQ9 scores') + xlab('Week in study') + ggtitle('PHQ9 scores stratified by study week') + scale_x_discrete(labels=xlabs)

tmp_phq2 <- phq2 %>% mutate(week_in_study = factor(as.character(week_in_study), levels=c(1:12)))
xlabs <- paste(levels(tmp_phq2$week_in_study),"\n(N=",table(tmp_phq2$week_in_study),")",sep="")
phq2_boxplot <- ggplot(data=tmp_phq2, aes(y=sum_phq2, x=week_in_study)) + geom_boxplot(alpha=.7) + theme_bw() + ylab('Sum PHQ2 scores') + xlab('Week in study') + ggtitle('PHQ2 scores stratified by study week') + scale_x_discrete(labels=xlabs)
gridExtra::grid.arrange(phq9_boxplot, phq2_boxplot, ncol=2)
```

##### Summary Distributions 
```{r, fig.height=4, fig.width=10}
tmp_phq9 <- phq9 %>% mutate(week_in_study = factor(week_in_study))
phq9_density <- ggplot(data=tmp_phq9, aes(x=sum_phq9)) + geom_density(alpha=.7) + theme_bw() + xlab('Sum PHQ9 scores')+ ggtitle('PHQ9 scores density')

tmp_phq2 <- phq2 %>% mutate(week_in_study = factor(week_in_study))
phq2_density <- ggplot(data=tmp_phq2, aes(x=sum_phq2)) + geom_density(alpha=.7) + theme_bw() + xlab('Sum PHQ2 scores') + ggtitle('PHQ2 scores density')
gridExtra::grid.arrange(phq9_density,phq2_density, ncol=2)
```


#### Compliance
```{r}
#compliance
total_uniq_users_with_anydata <- 
  unique(c(phq2$user_id,phq9$user_id,passivefeatures$user_id))

#PHQ2
#1. Percent uniq users per day of study
phq2Compliance <- phq2 %>% group_by(week_in_study) %>% 
  summarise(n = length(unique(user_id)) / length(total_uniq_users_with_anydata),
                                                             survey = 'active PHQ2') 
#Passive data
passiveDataCompliance <- passivefeatures %>% group_by(week_in_study) %>% summarise(n = length(unique(user_id)) /length(total_uniq_users_with_anydata) ,
                                                                             survey = 'passive features')

#PHQ9
phq9Compliance <- phq9 %>% filter(week_in_study %in% c(2,3,4,5,7,9,11,13)) %>%
  group_by(week_in_study) %>% summarise(n = length(unique(user_id)) /length(total_uniq_users_with_anydata),
                                                                survey = 'active PHQ9') 

compliance <- rbind(phq2Compliance, passiveDataCompliance, phq9Compliance)

p <- ggplot(data=compliance, aes(x=week_in_study, y=n*100, color=survey)) + geom_point(size=1) + geom_line(type='-')
p <- p + theme_bw() + ylab('compliance percentage') + xlab('study period [week 1-13]')
p <- p + theme(axis.text.x = element_text(angle =0, hjust = 1), text = element_text(size=10))  
p + scale_color_manual(values = c("#00AFBB", "#E7B800", "#FC4E07")) + ylim(0,100) + scale_x_discrete(limits=seq(1,13,1)) 
ggsave("plots/compliance_plot2.png", width=5, height=3, units="in", dpi=300)
```



#### Avg user participation / week

```{r}
phq2_surveys_compliance <- phq2 %>% group_by(user_id, week_in_study) %>% summarise(daysCollected = dplyr::n_distinct(phq2_date)) %>% mutate(type='phq2') %>% as.data.frame()

passiveFeatures_compliance <- passivefeatures %>% group_by(user_id, week_in_study) %>% summarise(daysCollected = dplyr::n_distinct(passive_date)) %>% mutate(type='passiveFeatures') %>% as.data.frame()

df <- rbind(phq2_surveys_compliance, passiveFeatures_compliance) %>% as.data.frame()
ggboxplot(df, x = "week_in_study", y = "daysCollected",
     fill = "type", palette = c("#00AFBB", "#E7B800"))
```


##### Missing Data - GingerIO Passive Data
Due to differences in phone operating system, iphone vs android we have missing features for passive data coming from iPhones
 
 *  The barplot on the left hand side shows the amount of missing/imputed values in each variable. 
 
 * In the aggregation plot on the right hand side, all existing combinations of missing/imputed(red) and non-missing values(blue) in the observations are visualized

```{r, fig.width=8, fig.height=4}
library("mice")
library("VIM")
colnames(passivefeatures)
cols_to_remove <- c('user_id', 'start', 'end', 'start_utc', 'study_arm' ,'study_start' ,'day_in_study', 'week_in_study', 
                    'study_start_utc_passive', 'passiveFeatureDate')
tmp <- passivefeatures
tmp <- tmp[,!colnames(tmp) %in% cols_to_remove]
colnames(tmp) <- c('SMS-len', 'UnretCalls' , 'CallDur', 'Mobility', 'InteracDiv', 'MissInterc' , 'AggComm', 'SMSCount' , 'MobRadius' , 'CallCount')
aggr_plot <- aggr(tmp, col=c('skyblue','#fc9272', 'grey50'), numbers=TRUE, sortVars=TRUE, ylab=c("Histogram of missing data","Pattern"), cex.axis=.6, digits=2, plot=T)
```


#### Passive Data summary
```{r, echo=F, warning=F, fig.width=10, fig.height=6}
cols_to_plot <- c('SMS_Length','Unreturned_Calls','Call_Duration','Mobility','SMS_Count','Call_Count')
tmp_hist_plot <- function(col, binwidth, color='#ffb400'){
  tmp <- passivefeatures[!is.na(passivefeatures[[col]]),]
  upper_cutoff <- as.numeric(quantile(tmp[[col]], probs=.95, na.rm=T))
  lower_cutoff <- as.numeric(quantile(tmp[[col]], probs=.05, na.rm=T))
  tmp <- tmp[tmp[[col]] < upper_cutoff & tmp[[col]] > lower_cutoff, ]
  ggplot(data=tmp, aes_string(x=col))  + theme_bw() + theme(text = element_text(size=8))  + geom_histogram(binwidth = binwidth, fill=color)
}

p1 <- tmp_hist_plot("SMS_Length", binwidth = 50) + xlab('length of SMS (in characters)')
p2 <- tmp_hist_plot("SMS_Count", binwidth = 5 ) + xlab('number of SMS sent')
passivefeatures['Call_Dur_mins'] = round(passivefeatures$Call_Duration/60)
p3 <- tmp_hist_plot("Call_Dur_mins", binwidth = 3) + xlab('call duration (minutes)')
p4 <- tmp_hist_plot('Call_Count', binwidth=1) + xlab('number of calls')
p5 <- tmp_hist_plot("Mobility", binwidth = .1) + xlab('Mobility')
p6 <- tmp_hist_plot('Mobility_Radius', binwidth=1) + xlab('Mobility Radius')
p7 <- gridExtra::grid.arrange(p1,p2,p3,p4,p5,p6, ncol=2)
ggsave("plots/feature_histograms.png", p7, width=4, height=4, units="in", dpi=300)
```








```{r}

tmp_cor <- function(x,y){
  to_del <- is.na(x) | is.na(y)
  cor(x[!to_del],y[!to_del], method="spearman")
}

tmp_cor_test <- function(x,y){
  to_del <- is.na(x) | is.na(y)
  cor.test(x[!to_del],y[!to_del])['p.value']
}

phq2_feature_corr <- phq2_passiveFeatures_demog %>% group_by(user_id) %>%
                       summarise(SMS_Length = tmp_cor(SMS_Length,sum_phq2),
                                 Unreturned_Calls = tmp_cor(Unreturned_Calls, sum_phq2),
                                 Call_Duration = tmp_cor(Call_Duration, sum_phq2),
                                 Mobility = tmp_cor(Mobility, sum_phq2),
                                 Interaction_Diversity = tmp_cor(Interaction_Diversity, sum_phq2),
                                 Missed_Interactions = tmp_cor(Missed_Interactions, sum_phq2),
                                 Aggregate_Communication = tmp_cor(Aggregate_Communication, sum_phq2),
                                 SMS_Count = tmp_cor(SMS_Count, sum_phq2),
                                 Mobility_Radius = tmp_cor(Mobility_Radius, sum_phq2),
                                 Call_Count = tmp_cor(Call_Count, sum_phq2),
                                 week_in_study = tmp_cor(week_in_study, sum_phq2))
phq2_feature_corr$user_id <- NULL 
pheatmap::pheatmap(phq2_feature_corr[complete.cases(phq2_feature_corr),], show_rownames=F, dendogram="none")



phq9_feature_corr <- phq9_passiveFeatures_phq2 %>% group_by(user_id) %>%
                       summarise(SMS_Length = tmp_cor(SMS_Length,sum_phq9),
                                 Unreturned_Calls = tmp_cor(Unreturned_Calls, sum_phq9),
                                 Call_Duration = tmp_cor(Call_Duration, sum_phq9),
                                 Mobility = tmp_cor(Mobility, sum_phq9),
                                 Interaction_Diversity = tmp_cor(Interaction_Diversity, sum_phq9),
                                 Missed_Interactions = tmp_cor(Missed_Interactions, sum_phq9),
                                 Aggregate_Communication = tmp_cor(Aggregate_Communication, sum_phq9),
                                 SMS_Count = tmp_cor(SMS_Count, sum_phq9),
                                 Mobility_Radius = tmp_cor(Mobility_Radius, sum_phq9),
                                 Call_Count = tmp_cor(Call_Count, sum_phq9),
                                 sum_phq2 = tmp_cor(sum_phq2, sum_phq9),
                                 week_in_study = tmp_cor(week_in_study, sum_phq9))
phq9_feature_corr$user_id <- NULL 
pheatmap::pheatmap(phq9_feature_corr[complete.cases(phq9_feature_corr),], show_rownames=F, dendogram="none")

individualFeatureTest <- function(individualUserData){
  features <- c('SMS_Length', 'Call_Duration', 'Mobility', 'Interaction_Diversity',
              'Aggregate_Communication', 'SMS_Count', 'Mobility_Radius', 'Call_Count')
  pvals <- sapply(features, function(f){
  tryCatch({
    individualUserData[f] <- log10(individualUserData[f] + .001)
    fit <- lm(paste0('sum_phq2 ~ ' , f), data=individualUserData)
    summary(fit)$coefficients[2,4]
  }, error = function(e){
    NA
  })
 })
p.adjust(pvals, method = "fdr")
}

res <- ddply(.data=phq9_passiveFeatures_phq2, .variables = c('user_id'),
      .fun = individualFeatureTest)
res$user_id <- NULL
res <- res[complete.cases(res),]
pheatmap(res)
```






```{r}
temp_user_plots <- function(users){
  #users <- c('67633')
  tmp_ginger_io_df <- passivefeatures %>% filter(user_id %in% users) %>% mutate(week_in_study = as.factor(week_in_study))
  tmp_phq9 <- phq9 %>% filter(user_id %in% users)
  tmp_phq2 <- phq2 %>% filter(user_id %in% users)
  
  #PHQ plots 
  phq9_week <- ggplot(data=tmp_phq9 , aes(x=factor(week_in_study), y=sum_phq9)) + geom_boxplot(width=.5) + xlab('week in study') + theme_bw()
 phq2_week <- ggplot(data=tmp_phq2 , aes(x=factor(week_in_study), y=sum_phq2)) + geom_boxplot(width=.5) + xlab('week in study') + theme_bw()
 phq2_week
 
 #passive data plots
  p1  <- ggplot(data=tmp_ginger_io_df, aes(x=week_in_study, y=log10(Mobility_Radius))) + geom_boxplot() + theme_bw()
  p2  <- ggplot(data=tmp_ginger_io_df, aes(x=week_in_study, y=log10(Call_Count))) + geom_boxplot() + theme_bw()
  p3  <- ggplot(data=tmp_ginger_io_df, aes(x=week_in_study, y=log10(SMS_Count))) + geom_boxplot() + theme_bw()
  p4  <- ggplot(data=tmp_ginger_io_df, aes(x=week_in_study, y=log10(Call_Duration))) + geom_boxplot() + theme_bw()
  multiplot(plotlist=list(phq9_week,p3,p2,phq2_week,p1,p4), cols=2)
}
```

### Participant Specific plots (N=1)
Choosen using a simple peronsalized linear model for each user

####Participant 1 - 67633
```{r, fig.width=8, fig.height=6}
temp_user_plots('67633') 
```

####Participant 2 - 16261
```{r, fig.width=8, fig.height=6}
temp_user_plots('16261') 
```

```{r, fig.width=8, fig.height=6, eval=F}
####Participant 3 - 34727
temp_user_plots('34727') 
```

```{r, fig.width=8, fig.height=6, eval=F}
####Participant 5 - 68974
temp_user_plots('68974') 
```



