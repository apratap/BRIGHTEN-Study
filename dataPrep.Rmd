---
title: "BRIGHTEN - Data Prep"
output: html_document
---

```{r setup, include=FALSE}
library(data.table)
library(gdata)
library(synapseClient)
synapseLogin()
library(ggplot2)
library(plyr)
library(dplyr)
library(tidyr)
library("reshape2")
library("knitr")

knitr::opts_chunk$set(echo = F,  message=FALSE, warning=FALSE)
knitr::opts_chunk$set(comment = NA, results = "asis", comment = NA, tidy = F)
```



```{r}
#PHQ9
phq9 <- read.xls(synGet('syn5908857')@filePath)
selcols <- paste0('ph', seq(1,9))
phq9['sum_phq9'] = rowSums(phq9[, selcols])
phq9$sent_time_utc <- as.POSIXct(phq9$sent_time_utc,tz='UTC')
phq9$response_utc <- as.POSIXct(phq9$response_utc,tz='UTC')


phq2 <- fread(synGet('syn5908863')@filePath, data.table=F)
phq2$sent_time_utc <- as.POSIXct(phq2$sent_time_utc, tz='UTC', format="%m/%d/%y %H:%M")
phq2$response_utc <- as.POSIXct(phq2$response_utc, tz='UTC', format="%m/%d/%y %H:%M")

#Study metadata
study_metadata <- read.xls(synGet('syn5908560')@filePath)

#add user-id to study metadata table
to_merge <- phq9[,c('brightenid','user_id')]
to_merge <- to_merge[!duplicated(to_merge),]
study_metadata <- merge(study_metadata, to_merge, all.x=T)

#GingerIO data
gingerio_data <- fread(synGet('syn5908849')@filePath, data.table = F)
gingerio_metadata <- fread(synGet('syn5908850')@filePath, data.table = F)
colnames(gingerio_metadata) <- gsub(' ', '_',colnames(gingerio_metadata))
colnames(gingerio_data) <- gsub(' ', '_',colnames(gingerio_data))
```



```{r}
selected_study_arms = c('GREEN', 'BLUE', 'ORANGE')
pattern = paste(selected_study_arms, collapse='|')
gingerio_metadata <- gingerio_metadata[grepl(pattern, gingerio_metadata$`Participant_ID`),]
selected_users <- unique(gingerio_metadata$user_id)

#keep only relevant users in ginger data
gingerio_data <- gingerio_data %>% dplyr::filter(user_id %in% selected_users)

#filter out rows that only 
x <- gingerio_data[,c(4:ncol(gingerio_data))]

#filter NA rows
rows_to_keep <- apply(gingerio_data[,-c(1,2,3)], 1, function(x) sum(is.na(x)) != 10 )
gingerio_data <- gingerio_data[rows_to_keep,]

#keep only relevant users in PHQ9 data
phq9 <- phq9 %>% dplyr::filter(user_id %in% selected_users) 


#Keep only those responses which are in STUDY ARM
# GREEN BLUE ORANGE
phq9['study_arm'] <- gsub('-.*','',phq9$brightenid)
phq9 <- phq9 %>% dplyr::filter(study_arm %in% selected_study_arms )

#keep only relevant users in PHQ2 data
phq2 <- phq2 %>% dplyr::filter(user_id %in% selected_users)

#calculate sum of PHQ2 scores
phq2['sum_PHQ2'] = phq2[,7] + phq2[,8]

#add study grp to PHQ2
phq2 <- merge(phq2, study_metadata[,c('user_id','Studygroup')])
phq2 <- phq2 %>% dplyr::mutate(Studygroup = as.character(Studygroup)) %>%
  filter(Studygroup != '')

#convert timestamp to POSIX class
gingerio_data <- gingerio_data %>% dplyr::mutate(end=as.POSIXct(end, tz="America/Los_Angeles",usetz=TRUE), start= as.POSIXct(start, tz="America/Los_Angeles",usetz=TRUE)) %>%
  mutate(start_utc =format(start, tz='UTC'))

### Add study arm info in ginger data
temp_df <- phq9[,c('user_id','study_arm')]
temp_df <- temp_df[!duplicated(temp_df),]
gingerio_data <- gingerio_data %>% mutate(study_arm = as.factor(study_arm))

gingerio_data$study_arm <- plyr::revalue(gingerio_data$study_arm, 
                                         replace = c('BLUE' = 'iPST',
                                                     'ORANGE' = 'Health Tips',
                                                     'GREEN' = 'Akili'))

phq2$study_arm <- plyr::revalue(phq2$Studygroup, 
                                 replace = c('BLUE' = 'iPST',
                                             'ORANGE' = 'Health Tips',
                                             'GREEN' = 'Akili'))

phq9$study_arm <- plyr::revalue(phq9$study_arm, 
                                 replace = c('BLUE' = 'iPST',
                                             'ORANGE' = 'Health Tips',
                                             'GREEN' = 'Akili'))

study_metadata$study_arm <- plyr::revalue(study_metadata$Studygroup, 
                                 replace = c('BLUE' = 'iPST',
                                             'ORANGE' = 'Health Tips',
                                             'GREEN' = 'Akili'))
```


```{r}
###upload the cleaned data to synapse
parentId <- "syn7211114"


```

